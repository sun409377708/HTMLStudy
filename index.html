<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥åº·æ™ºèƒ½ç®¡å®¶</title>
    <link rel="stylesheet" href="./styles.css">
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>å¥åº·æ™ºèƒ½ç®¡å®¶</h1>
        </header>

        <main class="chat-container">
            <div class="message assistant">
                <div class="avatar">AI</div>
                <div class="content">
                    æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„å¥åº·æ™ºèƒ½ç®¡å®¶ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›ä½“æ£€ã€å¥åº·å’¨è¯¢ç­‰æœåŠ¡ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ
                </div>
            </div>

            <div class="service-menu">
                <h2>çƒ­é—¨æœåŠ¡</h2>
                <div class="service-grid">
                    <div class="service-item">
                        <div class="service-icon">ğŸ¥</div>
                        <span>ä½“æ£€é¢„çº¦</span>
                    </div>
                    <div class="service-item">
                        <div class="service-icon">ğŸ“‹</div>
                        <span>æŠ¥å‘Šè§£è¯»</span>
                    </div>
                    <div class="service-item">
                        <div class="service-icon">â¤ï¸</div>
                        <span>å¥åº·æ¡£æ¡ˆ</span>
                    </div>
                    <div class="service-item">
                        <div class="service-icon">ğŸ”</div>
                        <span>ç—‡çŠ¶æŸ¥è¯¢</span>
                    </div>
                    <div class="service-item" onclick="toggleImageDropdown()">
                        <div class="service-icon">ğŸ¨</div>
                        <span>ç”Ÿæˆå›¾ç‰‡</span>
                    </div>
                    <div class="service-item" onclick="toggleFoodDropdown()">
                        <div class="service-icon">ğŸ±</div>
                        <span>é¤é£Ÿåˆ†æ</span>
                    </div>
                </div>
            </div>

            <div id="imageDropdown" class="dropdown-menu" style="display: none;">
                <div class="dropdown-content">
                    <div class="form-group">
                        <label>æè¿°ä½ æƒ³è¦çš„å›¾ç‰‡</label>
                        <textarea id="imagePrompt" placeholder="ä¾‹ï¼šä¸€åªå¯çˆ±çš„å°çŒ«åœ¨ç©æ¯›çº¿çƒ..." rows="3"></textarea>
                    </div>
                    <button id="generateBtn" class="submit-btn" onclick="generateImage()">ç”Ÿæˆå›¾ç‰‡</button>
                    <div id="imageResult" class="image-result">
                        <!-- ç”Ÿæˆçš„å›¾ç‰‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                    </div>
                    <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                        æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...
                    </div>
                </div>
            </div>

            <div id="foodDropdown" class="dropdown-menu" style="display: none;">
                <div class="dropdown-content">
                    <div class="upload-section">
                        <label for="foodImage" class="upload-label">
                            <div class="upload-icon">ğŸ“¸</div>
                            <span>ä¸Šä¼ é£Ÿç‰©å›¾ç‰‡</span>
                        </label>
                        <input type="file" id="foodImage" accept="image/*" style="display: none" onchange="analyzeFoodImage(event)">
                    </div>
                    <div id="foodImagePreview" class="image-preview"></div>
                    <div id="foodAnalysisResult" class="food-info" style="display: none;">
                        <h3>åˆ†æç»“æœ</h3>
                        <div class="calories"></div>
                        <div class="nutrition"></div>
                    </div>
                    <div id="foodLoadingIndicator" class="loading-indicator" style="display: none;">
                        æ­£åœ¨åˆ†æé£Ÿç‰©å›¾ç‰‡...
                    </div>
                </div>
            </div>

            <div class="quick-questions">
                <h2>å¸¸è§é—®é¢˜</h2>
                <div class="question-grid">
                    <button class="question-item">ä½“æ£€å‰éœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ</button>
                    <button class="question-item">å¦‚ä½•è§£è¯»ä½“æ£€æŠ¥å‘Šï¼Ÿ</button>
                    <button class="question-item">æ¨èé€‚åˆæˆ‘çš„ä½“æ£€å¥—é¤</button>
                    <button class="question-item">æœ€è¿‘ä½“æ£€ä¼˜æƒ æ´»åŠ¨</button>
                </div>
            </div>

            <div class="health-tips">
                <h2>å¥åº·å°è´´å£«</h2>
                <div class="tips-content">
                    å®šæœŸä½“æ£€æ˜¯é¢„é˜²ç–¾ç—…çš„é‡è¦æ‰‹æ®µï¼Œå»ºè®®æ¯å¹´è¿›è¡Œä¸€æ¬¡å…¨é¢ä½“æ£€ã€‚
                </div>
            </div>
        </main>

        <footer class="input-container">
            <div class="input-wrapper">
                <input type="text" id="messageInput" placeholder="è¯·è¾“å…¥æ‚¨çš„å¥åº·é—®é¢˜...">
                <button class="send-btn">å‘é€</button>
            </div>
        </footer>
    </div>

    <!-- åœ¨ script æ ‡ç­¾ä¹‹å‰æ·»åŠ  config.js å¼•ç”¨ -->
    <script src="./config.js"></script>

    <script>
        // è·å–DOMå…ƒç´ 
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.querySelector('.send-btn');
        const chatContainer = document.querySelector('.chat-container');
        const serviceItems = document.querySelectorAll('.service-item');
        const questionItems = document.querySelectorAll('.question-item');

        // ä¿®æ”¹å‘é€æ¶ˆæ¯å‡½æ•°
        async function sendMessage(text) {
            if (!text.trim()) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMessage = document.createElement('div');
            userMessage.className = 'message user fade-in';
            userMessage.innerHTML = `
                <div class="content">${text}</div>
            `;
            chatContainer.appendChild(userMessage);

            // æ·»åŠ AIæ€è€ƒçŠ¶æ€
            const aiMessage = document.createElement('div');
            aiMessage.className = 'message assistant fade-in';
            aiMessage.innerHTML = `
                <div class="avatar">AI</div>
                <div class="content typing-dots">æ€è€ƒä¸­...</div>
            `;
            chatContainer.appendChild(aiMessage);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            try {
                // è°ƒç”¨ deepseek API è·å–å›å¤
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",  // ä½¿ç”¨ deepseek æ¨¡å‹
                        messages: [
                            {
                                role: "system",
                                content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å¥åº·é¡¾é—®ï¼Œè¯·ç”¨ç®€çŸ­å‹å¥½çš„æ–¹å¼å›ç­”ç”¨æˆ·çš„å¥åº·ç›¸å…³é—®é¢˜ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ã€‚"
                            },
                            {
                                role: "user",
                                content: text
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const aiReply = data.choices[0].message.content;

                // æ›´æ–° AI å›å¤å†…å®¹
                aiMessage.innerHTML = `
                    <div class="avatar">AI</div>
                    <div class="content">${aiReply}</div>
                `;
            } catch (error) {
                // å¦‚æœå‡ºé”™ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                aiMessage.innerHTML = `
                    <div class="avatar">AI</div>
                    <div class="content">æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼š${error.message}</div>
                `;
                console.error('API Error:', error);
            }

            // æ¸…ç©ºè¾“å…¥æ¡†
            messageInput.value = '';
        }

        // å¤„ç†æœåŠ¡é¡¹ç‚¹å‡»
        function handleServiceClick(serviceName) {
            let message = '';
            switch(serviceName) {
                case 'ä½“æ£€é¢„çº¦':
                    message = 'ä½“æ£€é¢„çº¦æœåŠ¡åŒ…æ‹¬ï¼š\n1. ä¸ªæ€§åŒ–ä½“æ£€å¥—é¤æ¨è\n2. ä¸“å®¶é—¨è¯Šé¢„çº¦\n3. ä½“æ£€æ’\næ‚¨æƒ³äº†è§£å“ªé¡¹å…·ä½“æœåŠ¡ï¼Ÿ';
                    break;
                case 'æŠ¥å‘Šè§£è¯»':
                    message = 'ä½“æ£€æŠ¥å‘Šè§£è¯»æœåŠ¡åŒ…æ‹¬ï¼š\n1. æ£€æŸ¥æŒ‡æ ‡è¯´æ˜\n2. å¼‚å¸¸é¡¹åˆ†æ\n3. å¥åº·å»ºè®®\néœ€è¦æˆ‘ä¸ºæ‚¨è§£è¯»å“ªæ–¹é¢çš„å†…å®¹ï¼Ÿ';
                    break;
                case 'å¥åº·æ¡£æ¡ˆ':
                    message = 'å¥åº·æ¡£æ¡ˆæœåŠ¡åŒ…æ‹¬ï¼š\n1. ä¸ªäººå¥åº·è®°å½•\n2. ä½“æ£€å†å²æŸ¥è¯¢\n3. å¥åº·è¶‹åŠ¿åˆ†æ\næ‚¨éœ€è¦æŸ¥çœ‹å“ªé¡¹å†…å®¹ï¼Ÿ';
                    break;
                case 'ç—‡çŠ¶æŸ¥è¯¢':
                    message = 'è¯·æè¿°æ‚¨çš„ç—‡çŠ¶ï¼Œæˆ‘æ¥ä¸ºæ‚¨åˆ†æå¯èƒ½çš„åŸå› å’Œå»ºè®®ã€‚';
                    break;
                default:
                    message = 'æ‚¨æ‹©äº†' + serviceName + 'æœåŠ¡è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ';
            }
            sendMessage(message);
        }

        // ç»‘å®šå‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        sendButton.addEventListener('click', () => {
            sendMessage(messageInput.value);
        });

        // ç»‘å®šè¾“å…¥æ¡†å›è½¦äº‹ä»¶
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(messageInput.value);
            }
        });

        // ä¿®æ”¹æœåŠ¡é¡¹ç‚¹å‡»äº‹ä»¶ç»‘å®š
        serviceItems.forEach(item => {
            item.addEventListener('click', () => {
                const serviceName = item.querySelector('span').textContent;
                // å¦‚æœæ˜¯ç”Ÿæˆå›¾ç‰‡ã€é¤é£Ÿåˆ†ææˆ–å¥åº·æ¡£æ¡ˆæœåŠ¡ï¼Œä¸è§¦å‘é—®ç­”
                if (serviceName === 'ç”Ÿæˆå›¾ç‰‡' || 
                    serviceName === 'é¤é£Ÿåˆ†æ' || 
                    serviceName === 'å¥åº·æ¡£æ¡ˆ') {
                    return; // ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡ŒhandleServiceClick
                }
                
                handleServiceClick(serviceName);
                
                // æ·»åŠ ç‚¹å‡»æ•ˆæœ
                item.classList.add('service-active');
                setTimeout(() => {
                    item.classList.remove('service-active');
                }, 200);
            });
        });

        // ç»‘å®šé—®é¢˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        questionItems.forEach(button => {
            button.addEventListener('click', () => {
                sendMessage(button.textContent);
            });
        });

        // æ·»åŠ å›¾ç‰‡ç”ŸæˆåŠŸèƒ½
        async function generateImage() {
            const prompt = document.getElementById('imagePrompt').value;
            const loadingIndicator = document.getElementById('loadingIndicator');
            const imageResult = document.getElementById('imageResult');
            
            if (!prompt) {
                alert('è¯·è¾“å…¥å›¾ç‰‡æè¿°');
                return;
            }

            try {
                loadingIndicator.style.display = 'block';
                imageResult.innerHTML = '';

                const response = await fetch(CONFIG.STABILITY_API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${CONFIG.STABILITY_API_KEY}`
                    },
                    body: JSON.stringify({
                        text_prompts: [
                            {
                                text: prompt,
                                weight: 1
                            }
                        ],
                        cfg_scale: 7,
                        clip_guidance_preset: "FAST_BLUE",
                        height: 1024,
                        width: 1024,
                        samples: 1,
                        steps: 30,
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`å›¾ç‰‡ç”Ÿæˆå¤±è´¥: ${errorData.message || 'æœªçŸ¥é”™è¯¯'}`);
                }

                const result = await response.json();
                
                // æ£€æŸ¥è¿”å›çš„æ•°æ®ç»“æ„
                if (!result.artifacts || !result.artifacts[0]) {
                    throw new Error('è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }

                const image = document.createElement('img');
                image.src = `data:image/png;base64,${result.artifacts[0].base64}`;
                imageResult.appendChild(image);

            } catch (error) {
                alert('ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºé”™ï¼š' + error.message);
                console.error('API Error:', error);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // æ·»åŠ ä¸‹æ‹‰æ¡†æ§åˆ¶å‡½æ•°
        function toggleImageDropdown() {
            const dropdown = document.getElementById('imageDropdown');
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                setTimeout(() => dropdown.classList.add('show'), 10);
            } else {
                dropdown.classList.remove('show');
                setTimeout(() => dropdown.style.display = 'none', 300);
            }
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰æ¡†
        document.addEventListener('click', function(event) {
            const imageDropdown = document.getElementById('imageDropdown');
            const foodDropdown = document.getElementById('foodDropdown');
            const serviceItem = event.target.closest('.service-item');
            
            if (!serviceItem && !event.target.closest('.dropdown-menu')) {
                if (imageDropdown.style.display !== 'none') {
                    imageDropdown.classList.remove('show');
                    setTimeout(() => imageDropdown.style.display = 'none', 300);
                }
                if (foodDropdown.style.display !== 'none') {
                    foodDropdown.classList.remove('show');
                    setTimeout(() => foodDropdown.style.display = 'none', 300);
                }
            }
        });

        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.generateImage = generateImage;
        window.toggleImageDropdown = toggleImageDropdown;

        // æ·»åŠ å¥åº·æ¡£æ¡ˆç›¸å…³å‡½æ•°
        function showHealthRecord() {
            document.getElementById('healthRecordModal').style.display = 'block';
        }

        function closeHealthRecord() {
            document.getElementById('healthRecordModal').style.display = 'none';
        }

        function switchTab(tabId) {
            // åˆ‡æ¢æ ‡ç­¾é¡µæ ·å¼
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }

        function saveHealthRecord(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const record = Object.fromEntries(formData.entries());
            
            // æ·»åŠ æ—¶é—´æˆ³
            record.timestamp = new Date().toISOString();
            
            // è·å–å·²å­˜å‚¨çš„è®°å½•
            let records = JSON.parse(localStorage.getItem('healthRecords') || '[]');
            records.push(record);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('healthRecords', JSON.stringify(records));
            
            // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
            updateHistoryList();
            
            // é‡ç½®è¡¨å•
            form.reset();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert('å¥åº·æ¡£æ¡ˆä¿å­˜æˆåŠŸï¼');
        }

        function updateHistoryList() {
            const historyList = document.querySelector('.history-list');
            const records = JSON.parse(localStorage.getItem('healthRecords') || '[]');
            
            historyList.innerHTML = records.map((record, index) => `
                <div class="history-item">
                    <div class="history-header">
                        <h3>${record.name} çš„å¥åº·æ¡£æ¡ˆ</h3>
                        <span>${new Date(record.timestamp).toLocaleDateString()}</span>
                    </div>
                    <div class="history-details">
                        <p>å¹´é¾„ï¼š${record.age}å² | æ€§åˆ«ï¼š${record.gender === 'male' ? 'ç”·' : 'å¥³'}</p>
                        <p>èº«é«˜ï¼š${record.height}cm | ä½“é‡ï¼š${record.weight}kg | è¡€å‹ï¼š${record.bloodPressure || 'æœªå¡«å†™'}</p>
                        <p>æ—¢å¾€ç—…å²ï¼š${record.medicalHistory || 'æ— '}</p>
                        <p>ç”¨è¯è®°å½•ï¼š${record.medication || 'æ— '}</p>
                    </div>
                    <button class="delete-btn" onclick="deleteRecord(${index})">åˆ é™¤è®°å½•</button>
                </div>
            `).join('');
        }

        function deleteRecord(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                let records = JSON.parse(localStorage.getItem('healthRecords') || '[]');
                records.splice(index, 1);
                localStorage.setItem('healthRecords', JSON.stringify(records));
                updateHistoryList();
            }
        }

        // ä¿®æ”¹å¥åº·æ¡£æ¡ˆæœåŠ¡é¡¹çš„ç‚¹å‡»äº‹ä»¶
        document.querySelector('.service-item:nth-child(3)').onclick = showHealthRecord;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å†å²è®°å½•
        document.addEventListener('DOMContentLoaded', () => {
            updateHistoryList();
        });

        // æ·»åŠ é¤é£Ÿåˆ†æç›¸å…³å‡½æ•°
        function toggleFoodDropdown() {
            const dropdown = document.getElementById('foodDropdown');
            if (dropdown.style.display === 'none') {
                dropdown.style.display = 'block';
                setTimeout(() => dropdown.classList.add('show'), 10);
            } else {
                dropdown.classList.remove('show');
                setTimeout(() => dropdown.style.display = 'none', 300);
            }
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰æ¡†
        document.addEventListener('click', function(event) {
            const foodDropdown = document.getElementById('foodDropdown');
            const serviceItem = event.target.closest('.service-item');
            if (!serviceItem && !event.target.closest('.dropdown-menu')) {
                foodDropdown.classList.remove('show');
                setTimeout(() => foodDropdown.style.display = 'none', 300);
            }
        });

        async function analyzeFoodImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const preview = document.getElementById('foodImagePreview');
            const result = document.getElementById('foodAnalysisResult');
            const loadingIndicator = document.getElementById('foodLoadingIndicator');

            try {
                // æ˜¾ç¤ºé¢„è§ˆå›¾ç‰‡
                preview.innerHTML = '';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'preview-image';
                preview.appendChild(img);

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                loadingIndicator.style.display = 'block';
                result.style.display = 'none';

                // å°†å›¾ç‰‡è½¬æ¢ä¸º base64
                const base64Image = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                });

                // è°ƒç”¨ deepseek API åˆ†æå›¾ç‰‡
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                role: "system",
                                content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¥å…»å¸ˆï¼Œè¯·åˆ†æå›¾ç‰‡ä¸­çš„é£Ÿç‰©ï¼Œç»™å‡ºå¤§è‡´çš„çƒ­é‡å’Œè¥å…»æˆåˆ†ä¿¡æ¯ã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œå¹¶æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼šçƒ­é‡ï¼šxxxå¡è·¯é‡Œ\nè›‹ç™½è´¨ï¼šxxxå…‹\nç¢³æ°´ï¼šxxxå…‹\nè„‚è‚ªï¼šxxxå…‹\nå»ºè®®ï¼šxxx"
                            },
                            {
                                role: "user",
                                content: `è¯·åˆ†æè¿™å¼ é£Ÿç‰©å›¾ç‰‡ï¼š${base64Image}`
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error('åˆ†æå¤±è´¥');
                }

                const data = await response.json();
                const analysisText = data.choices[0].message.content;

                // è§£æè¿”å›çš„æ–‡æœ¬
                const calories = analysisText.match(/çƒ­é‡ï¼š(.*?)å¡è·¯é‡Œ/)?.[1] || 'æœªçŸ¥';
                const protein = analysisText.match(/è›‹ç™½è´¨ï¼š(.*?)å…‹/)?.[1] || 'æœªçŸ¥';
                const carbs = analysisText.match(/ç¢³æ°´ï¼š(.*?)å…‹/)?.[1] || 'æœªçŸ¥';
                const fat = analysisText.match(/è„‚è‚ªï¼š(.*?)å…‹/)?.[1] || 'æœªçŸ¥';
                const suggestion = analysisText.match(/å»ºè®®ï¼š(.*)/)?.[1] || 'æ— å…·ä½“å»ºè®®';

                // æ˜¾ç¤ºåˆ†æç»“æœ
                result.style.display = 'block';
                result.innerHTML = `
                    <h3>åˆ†æç»“æœ</h3>
                    <div class="calories">
                        é¢„ä¼°çƒ­é‡ï¼š${calories} åƒå¡
                    </div>
                    <div class="nutrition">
                        <div>è›‹ç™½è´¨ï¼š${protein}g</div>
                        <div>ç¢³æ°´ï¼š${carbs}g</div>
                        <div>è„‚è‚ªï¼š${fat}g</div>
                    </div>
                    <div class="suggestions">
                        <p>å»ºè®®ï¼š${suggestion}</p>
                    </div>
                `;

            } catch (error) {
                result.style.display = 'block';
                result.innerHTML = `
                    <h3>åˆ†æç»“æœ</h3>
                    <div class="error-message">
                        æŠ±æ­‰ï¼Œåˆ†æå‡ºé”™ï¼š${error.message}
                    </div>
                `;
                console.error('åˆ†æé”™è¯¯:', error);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.toggleFoodDropdown = toggleFoodDropdown;
        window.analyzeFoodImage = analyzeFoodImage;
    </script>

    <!-- åœ¨ body æ ‡ç­¾ç»“æŸå‰æ·»åŠ å¥åº·æ¡£æ¡ˆå¼¹çª— -->
    <div id="healthRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>å¥åº·æ¡£æ¡ˆ</h2>
                <span class="close-btn" onclick="closeHealthRecord()">&times;</span>
            </div>
            
            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchTab('newRecord')">æ–°å»ºæ¡£æ¡ˆ</button>
                <button class="tab-btn" onclick="switchTab('history')">å†å²è®°å½•</button>
            </div>

            <!-- æ–°å»ºæ¡£æ¡ˆè¡¨å• -->
            <div class="tab-content active" id="newRecord">
                <form id="healthRecordForm" onsubmit="saveHealthRecord(event)">
                    <div class="form-group">
                        <label>åŸºæœ¬ä¿¡æ¯</label>
                        <input type="text" placeholder="å§“å" name="name" required>
                        <input type="number" placeholder="å¹´é¾„" name="age" required>
                        <select name="gender" required>
                            <option value="">é€‰æ‹©æ€§åˆ«</option>
                            <option value="male">ç”·</option>
                            <option value="female">å¥³</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>èº«ä½“çŠ¶å†µ</label>
                        <div class="health-metrics">
                            <input type="number" placeholder="èº«é«˜(cm)" name="height" required>
                            <input type="number" placeholder="ä½“é‡(kg)" name="weight" required>
                            <input type="text" placeholder="è¡€å‹" name="bloodPressure">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>æ—¢å¾€ç—…å²</label>
                        <textarea name="medicalHistory" placeholder="è¯·å¡«å†™æ—¢å¾€ç—…å²..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>ç”¨è¯è®°å½•</label>
                        <textarea name="medication" placeholder="è¯·å¡«å†™æ­£åœ¨æœç”¨çš„è¯ç‰©..."></textarea>
                    </div>

                    <button type="submit" class="submit-btn">ä¿å­˜æ¡£æ¡ˆ</button>
                </form>
            </div>

            <!-- å†å²è®°å½•é¡µé¢ -->
            <div class="tab-content" id="history">
                <div class="history-list">
                    <!-- å†å²è®°å½•å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>
    </div>
</body>
</html> 